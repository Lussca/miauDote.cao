package adoteCaoProjetoController;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.security.Key;
import java.util.Base64;
import java.util.Date;

import javax.crypto.spec.SecretKeySpec;

import io.jsonwebtoken.JwtBuilder;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;

public class JwtHandler {
	private String getSecretKey(String key) throws IOException {
    	File f = new File("/miaudoteCao/admin/secretKey.ini");
    	FileInputStream fis = new FileInputStream(f);
    	byte[] content  = new byte[fis.available()];
    	fis.read();
    	String fileContent = new String(content);
    	String[] variables = fileContent.split("\r\n");
    	for(String variable: variables) {
    		int indexSeparator = variable.indexOf("=");
    		String keyTemp = variable.substring(0, indexSeparator);
    		if(keyTemp.equals(key)) {
    			fis.close();
    			return variable.substring(indexSeparator+1, variable.length());
    		}
    	}
    	fis.close();
		return null;
    }
	public String createJWT(String id, String issuer, String subject, long ttlMillis){
    	SignatureAlgorithm signatureAlgorithm = SignatureAlgorithm.HS256;
    	
    	long nowMillis = System.currentTimeMillis();
    	Date now  = new Date(nowMillis);
    	
    	byte[] apiKeySecretBytes = null;
		try {
			apiKeySecretBytes = Base64.getDecoder().decode(getSecretKey("secretKey"));
		} catch (IOException e) {
			e.printStackTrace();
		}
    	Key signingKey = new SecretKeySpec(apiKeySecretBytes, signatureAlgorithm.getJcaName());
    	@SuppressWarnings("deprecation")
		JwtBuilder builder = Jwts.builder().setId(id)
    			.setIssuedAt(now)
    			.setSubject(subject)
    			.setIssuer(issuer)
    			.signWith(signatureAlgorithm, signingKey);
    	if(ttlMillis > 0) {
    		long expMillis = nowMillis + ttlMillis;
    		Date exp = new Date(expMillis);
    		builder.setExpiration(exp);
    	}
    	return builder.compact();
    }
}
